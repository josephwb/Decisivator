Please note: this is undergoing essentially a complete rewrite.